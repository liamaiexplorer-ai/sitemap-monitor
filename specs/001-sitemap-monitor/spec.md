# 功能规格说明: Sitemap 变更监控系统

**功能分支**: `001-sitemap-monitor`
**创建日期**: 2025-12-04
**状态**: 草案
**输入**: 用户描述: "我想创建一个监控任意网站sitemap变更的项目，当sitemap变更时，可以将变更的内容以各种方式（可扩展）通知到用户，支持用户登陆和查看自己登记监控的网站及变更时间和变更内容等，需要有有简单易用且新手友好的功能和界面"

## 用户场景与测试 *(必填)*

### 用户故事 1 - 添加 Sitemap 监控 (优先级: P1)

作为一名网站管理员或 SEO 专家，我希望能够添加一个网站的 Sitemap URL 进行监控，以便在竞争对手或目标网站更新内容时第一时间获知。

**优先级原因**: 这是系统的核心功能，没有监控就没有后续的通知和查看功能。用户必须先能添加监控目标，系统才能发挥价值。

**独立测试**: 用户可以注册账号后添加一个 Sitemap URL，系统显示该 URL 已被成功添加到监控列表，即可验证此功能完整可用。

**验收场景**:

1. **Given** 用户已登录系统，**When** 用户输入有效的 Sitemap URL（如 https://example.com/sitemap.xml）并点击"添加监控"，**Then** 系统验证 URL 可访问后将其添加到用户的监控列表中，并显示成功提示
2. **Given** 用户已登录系统，**When** 用户输入无效或不可访问的 URL，**Then** 系统显示明确的错误信息说明失败原因（如"无法访问该 URL"或"该 URL 不是有效的 Sitemap 格式"）
3. **Given** 用户已添加某个 Sitemap 监控，**When** 用户尝试再次添加相同的 URL，**Then** 系统提示"该 Sitemap 已在监控列表中"

---

### 用户故事 2 - 接收变更通知 (优先级: P1)

作为用户，当我监控的 Sitemap 发生变更时，我希望能通过我选择的方式（如邮件、Webhook）收到通知，以便及时了解网站更新情况。

**优先级原因**: 主动通知是监控系统的核心价值，用户无需主动查看即可获知变更，这是区别于手动检查的关键功能。

**独立测试**: 添加一个 Sitemap 监控后，当该 Sitemap 发生变更时（可通过测试环境模拟），用户能在配置的通知渠道收到变更通知。

**验收场景**:

1. **Given** 用户已配置邮件通知且监控某 Sitemap，**When** 该 Sitemap 新增了 URL，**Then** 用户在 5 分钟内收到邮件通知，内容包含新增 URL 列表
2. **Given** 用户已配置 Webhook 通知且监控某 Sitemap，**When** 该 Sitemap 删除了 URL，**Then** 系统向配置的 Webhook 地址发送 POST 请求，包含删除的 URL 列表
3. **Given** 用户已配置邮件通知且监控某 Sitemap，**When** 该 Sitemap 中某 URL 的最后修改时间（lastmod）发生变化，**Then** 用户收到邮件通知，包含变更的 URL 及新旧修改时间

---

### 用户故事 3 - 查看监控列表和变更历史 (优先级: P2)

作为用户，我希望能在界面上查看我所有监控的 Sitemap 列表，以及每个 Sitemap 的变更历史记录，以便回顾和分析网站更新模式。

**优先级原因**: 这是用户管理和分析的基础功能，虽然不如主动通知紧急，但对于用户理解监控状态和历史变更至关重要。

**独立测试**: 用户登录后进入"我的监控"页面，可以看到所有已添加的 Sitemap 列表，点击任意一个可查看其变更历史。

**验收场景**:

1. **Given** 用户已登录且有多个监控任务，**When** 用户访问"我的监控"页面，**Then** 系统显示所有监控的 Sitemap 列表，包括 URL、添加时间、最后检查时间、状态（正常/异常）
2. **Given** 用户正在查看监控列表，**When** 用户点击某个 Sitemap 条目，**Then** 系统显示该 Sitemap 的变更历史，按时间倒序排列，每条记录包含变更时间、变更类型（新增/删除/修改）、受影响的 URL 数量
3. **Given** 用户正在查看某 Sitemap 的变更历史，**When** 用户点击某条变更记录，**Then** 系统显示该次变更的详细内容（新增了哪些 URL、删除了哪些 URL、哪些 URL 的信息发生了变化）

---

### 用户故事 4 - 用户注册与登录 (优先级: P2)

作为新用户，我希望能够快速注册账号并登录系统，以便开始使用 Sitemap 监控功能。

**优先级原因**: 用户系统是多用户场景的基础，虽然技术上可以后置，但用户需要账号来管理自己的监控任务和通知配置。

**独立测试**: 新用户可以通过注册页面创建账号，然后使用该账号登录系统进入主界面。

**验收场景**:

1. **Given** 用户在注册页面，**When** 用户输入有效的邮箱和密码并提交，**Then** 系统创建账号并发送验证邮件，用户可以登录
2. **Given** 用户已有账号，**When** 用户输入正确的邮箱和密码，**Then** 系统验证成功后跳转到用户主界面
3. **Given** 用户已登录，**When** 用户点击"退出登录"，**Then** 系统清除登录状态并跳转到登录页面

---

### 用户故事 5 - 配置通知渠道 (优先级: P3)

作为用户，我希望能够配置多种通知方式（邮件、Webhook 等），并为不同的监控任务选择不同的通知渠道，以便灵活管理通知。

**优先级原因**: 通知渠道的灵活配置提升用户体验，但基础功能可以先用默认的邮件通知，渠道扩展是增强功能。

**独立测试**: 用户可以在"通知设置"页面添加 Webhook 地址，然后在某个监控任务上启用该 Webhook 通知。

**验收场景**:

1. **Given** 用户在通知设置页面，**When** 用户添加一个 Webhook URL 并保存，**Then** 系统验证该 URL 可访问后保存配置，显示在用户的通知渠道列表中
2. **Given** 用户已配置多个通知渠道，**When** 用户编辑某个监控任务，**Then** 用户可以选择该任务使用哪些通知渠道（可多选）
3. **Given** 用户已配置 Webhook 通知，**When** 用户点击"测试"按钮，**Then** 系统向该 Webhook 发送测试请求并显示响应结果

---

### 用户故事 6 - 新手引导 (优先级: P3)

作为首次使用系统的新手用户，我希望有清晰的引导帮助我快速上手，以便尽快开始监控我关心的网站。

**优先级原因**: 新手友好是用户描述中明确提出的需求，但这是体验优化而非核心功能，可在基础功能完成后添加。

**独立测试**: 新用户首次登录后，系统显示引导流程，用户可以跟随引导完成第一个 Sitemap 监控任务的创建。

**验收场景**:

1. **Given** 用户首次登录系统，**When** 用户进入主界面，**Then** 系统显示欢迎引导，介绍系统主要功能和操作步骤
2. **Given** 用户正在引导流程中，**When** 用户按照引导添加第一个 Sitemap，**Then** 系统在每个步骤提供清晰的说明和提示
3. **Given** 用户已完成引导，**When** 用户再次登录，**Then** 系统不再显示引导流程（除非用户主动触发"重新查看引导"）

---

### 边界情况

- **Sitemap 格式多样性**: 当 Sitemap 是 Sitemap Index（包含多个子 Sitemap 链接）时，系统 MUST 递归解析所有子 Sitemap
- **大型 Sitemap 处理**: 当 Sitemap 包含超过 10 万个 URL 时，系统 MUST 能正常处理而不超时或崩溃
- **网络异常处理**: 当目标网站暂时不可访问时，系统 MUST 记录错误并在下次检查时重试，连续多次失败后通知用户
- **Sitemap 格式错误**: 当 Sitemap 内容不是有效的 XML 格式时，系统 MUST 提示具体的解析错误
- **URL 变更检测准确性**: 系统 MUST 准确区分新增、删除和修改，避免因解析顺序不同导致误报
- **频繁变更合并**: 当 Sitemap 在短时间内多次变更时，系统 SHOULD 合并通知避免打扰用户

## 需求 *(必填)*

### 功能需求

**Sitemap 监控核心**:

- **FR-001**: 系统 MUST 支持用户添加任意有效的 Sitemap URL 进行监控
- **FR-002**: 系统 MUST 支持标准 Sitemap 格式（XML）以及 Sitemap Index 格式
- **FR-003**: 系统 MUST 定期检查已监控的 Sitemap（默认检查间隔为 1 小时）
- **FR-004**: 系统 MUST 检测 Sitemap 中 URL 的新增、删除和 lastmod 变更
- **FR-005**: 系统 MUST 记录每次检查的结果和变更内容

**用户管理**:

- **FR-006**: 系统 MUST 支持用户通过邮箱和密码注册账号
- **FR-007**: 系统 MUST 支持用户登录和退出
- **FR-008**: 系统 MUST 支持用户修改密码
- **FR-009**: 系统 MUST 支持用户通过邮件重置忘记的密码

**通知系统**:

- **FR-010**: 系统 MUST 支持通过邮件发送变更通知（默认通知方式）
- **FR-011**: 系统 MUST 支持通过 Webhook 发送变更通知（可扩展的通知方式）
- **FR-012**: 系统 MUST 允许用户为每个监控任务选择通知渠道
- **FR-013**: 通知内容 MUST 包含变更类型、受影响的 URL 列表和变更时间

**界面与体验**:

- **FR-014**: 系统 MUST 提供 Web 界面供用户管理监控任务
- **FR-015**: 系统 MUST 在界面上显示监控列表、变更历史和通知配置
- **FR-016**: 系统 MUST 为首次使用的用户提供新手引导
- **FR-017**: 界面 MUST 响应式设计，支持桌面和移动设备访问

**数据管理**:

- **FR-018**: 系统 MUST 保留变更历史记录至少 90 天
- **FR-019**: 用户 MUST 能够删除自己添加的监控任务
- **FR-020**: 用户 MUST 能够暂停和恢复监控任务

### 关键实体

- **用户（User）**: 系统的使用者，拥有邮箱、密码、注册时间等属性，可以管理多个监控任务和通知配置
- **监控任务（MonitorTask）**: 代表一个被监控的 Sitemap，包含 URL、创建时间、检查间隔、状态（启用/暂停）、关联的通知渠道
- **Sitemap 快照（SitemapSnapshot）**: 某次检查时 Sitemap 的完整内容记录，包含检查时间和所有 URL 及其属性
- **变更记录（ChangeRecord）**: 两次快照之间的差异，包含变更时间、变更类型（新增/删除/修改）、受影响的 URL 列表
- **通知渠道（NotificationChannel）**: 用户配置的通知方式，包含类型（邮件/Webhook）、配置参数（邮箱地址或 Webhook URL）
- **通知日志（NotificationLog）**: 已发送通知的记录，包含发送时间、接收渠道、发送状态、通知内容摘要

## 假设

以下是基于常见实践做出的合理假设：

1. **认证方式**: 采用邮箱 + 密码的传统认证方式，暂不支持第三方 OAuth 登录
2. **检查间隔**: 默认 1 小时检查一次，用户可在 15 分钟到 24 小时之间自定义
3. **数据保留**: 变更历史保留 90 天，超过 90 天的记录自动清理
4. **通知频率**: 每次检测到变更立即发送通知，不做聚合（用户可选择暂停通知）
5. **免费额度**: 单用户最多监控 10 个 Sitemap（未来可通过付费扩展）
6. **Webhook 格式**: 使用 JSON 格式发送 POST 请求，包含标准字段（事件类型、时间戳、变更内容）
7. **邮件发送**: 使用系统配置的 SMTP 服务发送，不支持用户自定义 SMTP
8. **语言**: 界面和通知内容默认为中文

## 成功标准 *(必填)*

### 可衡量结果

- **SC-001**: 用户从注册到成功添加第一个 Sitemap 监控的时间不超过 3 分钟
- **SC-002**: 系统检测到 Sitemap 变更后，在 5 分钟内发送通知
- **SC-003**: 系统能够处理包含 10 万个 URL 的大型 Sitemap，单次检查耗时不超过 60 秒
- **SC-004**: 新手用户首次使用时，90% 的用户能在无外部帮助下完成第一个监控任务
- **SC-005**: 系统支持同时监控至少 1000 个不同的 Sitemap
- **SC-006**: 变更检测准确率达到 100%（无漏报和误报）
- **SC-007**: 界面在移动设备上的可用性评分达到 80 分以上（基于标准可用性测试）
- **SC-008**: 系统可用性达到 99.5%（月度可用时间 / 月度总时间）
